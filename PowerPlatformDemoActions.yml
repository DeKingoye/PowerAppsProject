name: Power Platform Export and Publish

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set PAC global path
        run: |
          Write-Host "Using global PAC path from .NET tools..."
          echo "PAC_PATH=C:\Users\yannm\.dotnet\tools\pac.exe" >> $env:GITHUB_ENV
        shell: pwsh

      - name: ğŸ” Verify PAC installation
        run: |
          Write-Host "PAC path: $env:PAC_PATH"
          & $env:PAC_PATH version
        shell: pwsh

      - name: ğŸ” Authenticate to Power Platform
        run: |
          & $env:PAC_PATH auth clear
          & $env:PAC_PATH auth create --environment "https://org643d7b2c.crm12.dynamics.com" --username "nicoise.nkounkou@edu.igensia.com" --password "${{ secrets.PASSWORD }}"
          & $env:PAC_PATH auth list
        shell: pwsh

      - name: ğŸ“¦ Export Solution
        run: |
          Write-Host "Exporting solution..."
          & $env:PAC_PATH solution export --path "out\aSolution.zip" --name "aSolution" --managed false --overwrite
        shell: pwsh

      - name: ğŸ“‚ Unpack Solution
        run: |
          Write-Host "Unpacking solution..."
          & $env:PAC_PATH solution unpack --zipfile "out\aSolution.zip" --folder "out\solutions\solution-one" --packagetype "Unmanaged" --clobber
        shell: pwsh

      - name: ğŸš€ Publish Solution
        run: |
          Write-Host "Publishing solution..."
          & $env:PAC_PATH solution publish
        shell: pwsh

      - name: ğŸ§¾ Commit solution changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if (Test-Path "out/solutions/solution-one") {
            git add out/solutions/solution-one
            git commit -m "ğŸ”„ Update unpacked Power Platform solution"
            git push origin master
          } else {
            Write-Host "âœ… Nothing to commit."
          }
        shell: pwsh
