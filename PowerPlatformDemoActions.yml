name: Power Platform Export and Publish

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: self-hosted

    steps:
      # --- üß© Cloner le d√©p√¥t ---
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # --- ‚öôÔ∏è Pr√©parer Power Platform CLI ---
      - name: ‚öôÔ∏è Pr√©parer Power Platform CLI pour le runner
        run: |
          $source = "C:\Users\yannm\.dotnet\tools"
          $destination = "C:\Users\yannm\actions-runner\_work\PowerAppsProject\PowerAppsProject\pac"
          
          if (-Not (Test-Path $destination)) {
            New-Item -ItemType Directory -Path $destination | Out-Null
          }

          Copy-Item -Path "$source\*" -Destination $destination -Recurse -Force
          Write-Host "‚úÖ pac.exe copi√© dans le workspace: $destination"
          Get-ChildItem -Path $destination
        shell: pwsh

      # --- üîç V√©rification de l'installation PAC ---
      - name: üîç Verify PAC installation
        run: |
          $pacPath = "C:\Users\yannm\actions-runner\_work\PowerAppsProject\PowerAppsProject\pac\pac.exe"
          if (-Not (Test-Path $pacPath)) {
            Write-Error "‚ùå pac.exe introuvable dans $pacPath ‚Äî v√©rifie l'installation."
            exit 1
          }
          Write-Host "‚úÖ PAC CLI d√©tect√© dans $pacPath"
          & $pacPath help
        shell: pwsh

      # --- üì¶ Export de la solution ---
      - name: üì¶ Export Solution
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: 'https://org643d7b2c.crm12.dynamics.com'
          user-name: 'nicoise.nkounkou@edu.igensia.com'
          password-secret: ${{ secrets.PASSWORD }}
          solution-name: 'aSolution'
          solution-output-file: 'aSolution.zip'
          working-directory: 'out'
          managed: false
          run-asynchronously: false
        env:
          POWERPLATFORMTOOLS_PACINSTALLED: true
          POWERPLATFORMTOOLS_PACPATH: C:\Users\yannm\actions-runner\_work\PowerAppsProject\PowerAppsProject\pac\pac.exe
          PAC_PATH: C:\Users\yannm\actions-runner\_work\PowerAppsProject\PowerAppsProject\pac\pac.exe

      # --- üìÇ D√©compression de la solution ---
      - name: üìÇ Unpack Solution
        uses: microsoft/powerplatform-actions/unpack-solution@v1
        with:
          solution-file: 'out/aSolution.zip'
          solution-folder: 'out/solutions/solution-one'
          solution-type: 'Unmanaged'
          overwrite-files: true
        env:
          POWERPLATFORMTOOLS_PACPATH: C:\Users\yannm\actions-runner\_work\PowerAppsProject\PowerAppsProject\pac\pac.exe

      # --- üöÄ Publication de la solution ---
      - name: üöÄ Publish Solution
        uses: microsoft/powerplatform-actions/publish-solution@v1
        with:
          environment-url: 'https://org643d7b2c.crm12.dynamics.com'
          user-name: 'nicoise.nkounkou@edu.igensia.com'
          password-secret: ${{ secrets.PASSWORD }}
        env:
          POWERPLATFORMTOOLS_PACPATH: C:\Users\yannm\actions-runner\_work\PowerAppsProject\PowerAppsProject\pac\pac.exe

      # --- üßæ Commit des changements ---
      - name: üßæ Commit solution changes
        uses: microsoft/powerplatform-actions/branch-solution@v1
        with:
          solution-folder: 'out/solutions/solution-one'
          solution-target-folder: 'src/solutions/solution1'
          token: ${{ secrets.GIT_TOKEN }}
