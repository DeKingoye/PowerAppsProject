name: Power Platform Demo Actions

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: self-hosted  # âœ… ton runner local

    steps:
      # ðŸ§© Ã‰tape 1 : Cloner le dÃ©pÃ´t
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ§© Ã‰tape 2 : Installer Node.js 18 (pour compatibilitÃ© CLI)
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # ðŸ§© Ã‰tape 3 : Installer la Power Platform CLI officielle
      - name: Install Microsoft Power Platform CLI
        run: |
          npm install -g @microsoft/powerplatform-cli@latest
          pac --version

      # ðŸ§© Ã‰tape 4 : Authentifier dans Power Platform (vÃ©rification)
      - name: Check Power Platform Authentication
        run: |
          pac auth clear
          pac auth create --url https://org643d7b2c.crm12.dynamics.com --username nicoise.nkounkou@edu.igensia.com --password $env:PASSWORD
          pac auth list
        env:
          PASSWORD: ${{ secrets.PASSWORD }}

      # ðŸ§© Ã‰tape 5 : Exporter la solution
      - name: Export Solution
        run: |
          mkdir out
          pac solution export `
            --path out/aSolution.zip `
            --name aSolution `
            --environment https://org643d7b2c.crm12.dynamics.com
        env:
          PASSWORD: ${{ secrets.PASSWORD }}

      # ðŸ§© Ã‰tape 6 : DÃ©compresser la solution
      - name: Unpack Solution
        run: |
          pac solution unpack `
            --zipfile out/aSolution.zip `
            --folder out/solutions/solution-one `
            --allowDelete true `
            --overwrite true

      # ðŸ§© Ã‰tape 7 : Publier la solution
      - name: Publish Solution
        run: |
          pac solution publish `
            --environment https://org643d7b2c.crm12.dynamics.com

      # ðŸ§© Ã‰tape 8 : PrÃ©parer les changements pour commit
      - name: Prepare solution changes for check-in into source control
        uses: microsoft/powerplatform-actions/branch-solution@v1
        with:
          solution-folder: 'out/solutions/solution-one'
          solution-target-folder: 'src/solutions/solution1'
          token: ${{ secrets.GIT_TOKEN }}
