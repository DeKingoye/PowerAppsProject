name: Power Platform Demo Actions

on:
  workflow_dispatch:  # üëà permet de le lancer manuellement depuis l‚Äôonglet Actions
  push:
    branches:
      - master          # üëà permet de le d√©clencher automatiquement sur les pushs vers master

jobs:
  build:
    # üñ•Ô∏è Le job s‚Äôex√©cute sur ton runner local
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Hello from Yann's Runner üëã
        run: echo "‚úÖ Workflow d√©marr√© sur le runner local de Yann !"

      # 1Ô∏è‚É£ Installe Node.js (n√©cessaire pour npm/pac)
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 2Ô∏è‚É£ Installe le Power Platform CLI (pac)
      - name: Install Power Platform CLI manually
        run: |
          npm install -g pac
          pac --version

      # 3Ô∏è‚É£ (optionnel mais utile) V√©rifie que pac est bien accessible
      - name: Verify pac installation
        run: |
          echo "üîç V√©rification de pac CLI..."
          pac help

      # 4Ô∏è‚É£ Installe les Power Platform Tools GitHub Actions
      - name: Install Power Platform Tools
        uses: microsoft/powerplatform-actions/actions-install@v1

      # 5Ô∏è‚É£ Exporte ta solution Power Platform
      - name: Export Solution
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: 'https://org643d7b2c.crm12.dynamics.com'
          user-name: 'nicoise.nkounkou@edu.igensia.com'
          password-secret: ${{ secrets.PASSWORD }}
          solution-name: 'aSolution'  # ‚ö†Ô∏è √† remplacer par le nom logique exact de ta solution Power Platform
          solution-output-file: 'aSolution.zip'
          working-directory: 'out'

      # 6Ô∏è‚É£ D√©compresse la solution export√©e
      - name: Unpack Solution
        uses: microsoft/powerplatform-actions/unpack-solution@v1
        with:
          solution-file: 'out/aSolution.zip'
          solution-folder: 'out/solutions/solution-one'
          solution-type: 'Unmanaged'
          overwrite-files: true

      # 7Ô∏è‚É£ Publie la solution dans l‚Äôenvironnement
      - name: Publish Solution
        uses: microsoft/powerplatform-actions/publish-solution@v1
        with:
          environment-url: 'https://org643d7b2c.crm12.dynamics.com'
          user-name: 'nicoise.nkounkou@edu.igensia.com'
          password-secret: ${{ secrets.PASSWORD }}

      # 8Ô∏è‚É£ Pr√©pare les changements pour le commit
      - name: Prepare solution changes for check-in into source control
        uses: microsoft/powerplatform-actions/branch-solution@v1
        with:
          solution-folder: 'out/solutions/solution-one'
          solution-target-folder: 'src/solutions/solution1'
          token: ${{ secrets.GIT_TOKEN }}
