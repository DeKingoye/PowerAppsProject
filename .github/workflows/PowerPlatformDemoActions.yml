name: Power Platform Demo Actions (Direct PAC)

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Environment info
        shell: pwsh
        run: |
          Write-Host "üß† OS:" (Get-CimInstance Win32_OperatingSystem).Caption
          Write-Host "üíª PowerShell:" $PSVersionTable.PSVersion

      # 1) Trouver pac.exe de mani√®re fiable
      - name: Locate pac.exe
        id: find_pac
        shell: pwsh
        run: |
          function Find-PacPath {
            # 1. Si 'pac' est dans le PATH (App Execution Alias / MSI), on r√©cup√®re sa cible r√©elle
            $cmd = Get-Command pac -ErrorAction SilentlyContinue
            if ($cmd -and $cmd.Source) {
              return $cmd.Source
            }

            # 2. Emplacements classiques (MSI / winget / NuGet)
            $candidates = @(
              "$env:ProgramFiles (x86)\Microsoft Power Platform CLI\pac.exe",
              "$env:ProgramFiles\Microsoft Power Platform CLI\pac.exe",
              "$env:LOCALAPPDATA\Microsoft\PowerAppsCLI\pac.exe",
              "$env:USERPROFILE\.nuget\packages\microsoft.powerapps.cli\**\tools\pac.exe"
            )

            foreach ($c in $candidates) {
              $expanded = [Environment]::ExpandEnvironmentVariables($c)
              $found = Get-ChildItem -Path $expanded -File -ErrorAction SilentlyContinue
              if ($found) { return $found[0].FullName }
            }

            # 3. Recherche cibl√©e sur C:\ (derni√®re chance, plus lente)
            $foundWide = Get-ChildItem -Path 'C:\' -Filter 'pac.exe' -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($foundWide) { return $foundWide.FullName }

            return $null
          }

          $pac = Find-PacPath
          if (-not $pac) {
            Write-Host "‚ùå pac.exe introuvable ‚Äî tentative d‚Äôinstallation via winget (MSStore)‚Ä¶"
            winget install --id Microsoft.PowerAppsCLI -e --accept-package-agreements --accept-source-agreements
            Start-Sleep -Seconds 5
            $pac = Find-PacPath
          }

          if (-not $pac) {
            Write-Error "Impossible de localiser pac.exe apr√®s installation."
            exit 1
          }

          Write-Host "‚úÖ pac.exe : $pac"
          "PAC_PATH=$pac" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # 2) Auth Power Platform (sans guillemets autour du password)
      - name: Authenticate to Power Platform
        shell: pwsh
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          $pac = $env:PAC_PATH
          Write-Host "üîê Auth with PAC at $pac"
          & $pac auth clear
          & $pac auth create --url "https://org643d7b2c.crm12.dynamics.com" --username "nicoise.nkounkou@edu.igensia.com" --password $env:PASSWORD
          & $pac auth list
          # test de connectivit√© simple
          & $pac env who

      # 3) Export solution ‚Üí out\aSolution.zip
      - name: Export solution (pac)
        shell: pwsh
        run: |
          $pac = $env:PAC_PATH
          New-Item -ItemType Directory -Path out -Force | Out-Null
          Write-Host "üì¶ Exporting solution 'aSolution'‚Ä¶"
          & $pac solution export `
            --name "aSolution" `
            --path "out\aSolution.zip" `
            --environment "https://org643d7b2c.crm12.dynamics.com"

      # 4) Unpack solution ‚Üí out\solutions\solution-one
      - name: Unpack solution (pac)
        shell: pwsh
        run: |
          $pac = $env:PAC_PATH
          Write-Host "üìÇ Unpacking solution to out\solutions\solution-one‚Ä¶"
          & $pac solution unpack `
            --zipfile "out\aSolution.zip" `
            --folder "out\solutions\solution-one" `
            --allowDelete true `
            --overwrite true

      # 5) Publish solution
      - name: Publish solution (pac)
        shell: pwsh
        run: |
          $pac = $env:PAC_PATH
          Write-Host "üöÄ Publishing solution‚Ä¶"
          & $pac solution publish --environment "https://org643d7b2c.crm12.dynamics.com"

      # 6) Commit des modifs dans le repo
      - name: Commit solution to repo
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "out/solutions/solution-one" -A
          if ((git status --porcelain) -ne $null) {
            git commit -m "chore: export & unpack solution-one"
            git push
          } else {
            Write-Host "‚úÖ Rien √† committer."
          }
