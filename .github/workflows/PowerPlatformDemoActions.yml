name: Power Platform Export and Publish

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: self-hosted  # ton runner Windows local

    steps:
      # √âtape 1 : Cloner le d√©p√¥t
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # √âtape 2 : Installer le Power Platform CLI (actions-install)
      - name: ‚öôÔ∏è Install Power Platform Tools
        uses: microsoft/powerplatform-actions/actions-install@v1

      # √âtape 3 : Authentification (bas√©e sur ton profil MFA local)
      - name: üîê Verify local authentication profile
        run: |
          Write-Host "V√©rification des profils PAC locaux..."
          $pac = "C:\Users\yannm\AppData\Local\Microsoft\PowerAppsCLI\pac.cmd"
          & $pac auth list
        shell: pwsh

      # √âtape 4 : Exporter la solution
      - name: üì¶ Export Solution
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: 'https://org643d7b2c.crm12.dynamics.com'
          user-name: 'nicoise.nkounkou@edu.igensia.com'
          password-secret: ${{ secrets.PASSWORD }} # gard√© pour compatibilit√©, m√™me si le profil MFA est prioritaire
          solution-name: 'aSolution'
          solution-output-file: 'aSolution.zip'
          working-directory: 'out'

      # √âtape 5 : D√©compresser la solution
      - name: üìÇ Unpack Solution
        uses: microsoft/powerplatform-actions/unpack-solution@v1
        with:
          solution-file: 'out/aSolution.zip'
          solution-folder: 'out/solutions/solution-one'
          solution-type: 'Unmanaged'
          overwrite-files: true

      # √âtape 6 : Publier la solution
      - name: üöÄ Publish Solution
        uses: microsoft/powerplatform-actions/publish-solution@v1
        with:
          environment-url: 'https://org643d7b2c.crm12.dynamics.com'
          user-name: 'nicoise.nkounkou@edu.igensia.com'
          password-secret: ${{ secrets.PASSWORD }}

      # √âtape 7 : Commit des changements
      - name: üßæ Commit changes to repository
        uses: microsoft/powerplatform-actions/branch-solution@v1
        with:
          solution-folder: 'out/solutions/solution-one'
          solution-target-folder: 'src/solutions/solution1'
          token: ${{ secrets.GIT_TOKEN }}
