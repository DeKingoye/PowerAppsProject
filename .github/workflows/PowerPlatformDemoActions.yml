name: Power Platform Demo Actions

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: self-hosted

    steps:
      # √âtape 1 : Cloner le d√©p√¥t
      - name: Checkout repository
        uses: actions/checkout@v4

      # √âtape 2 : Informations syst√®me
      - name: Check environment info
        shell: powershell
        run: |
          Write-Host "üß† OS:" (Get-CimInstance Win32_OperatingSystem).Caption
          Write-Host "üíª PowerShell version:" $PSVersionTable.PSVersion

      # √âtape 3 : Installation du CLI Power Platform
      - name: Install Power Platform CLI via Winget
        shell: powershell
        run: |
          Write-Host "Installing Power Platform CLI..."
          winget install --id Microsoft.PowerAppsCLI -e --accept-source-agreements --accept-package-agreements
          Write-Host "Searching pac.exe..."
          $pac = (Get-ChildItem -Path "C:\" -Filter "pac.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          if ($pac) {
            Write-Host "‚úÖ PAC found at: $pac"
            echo "PAC_PATH=$pac" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            & $pac help
          } else {
            Write-Error "‚ùå PAC not found anywhere on the system."
            exit 1
          }

      # √âtape 4 : Authentification
      - name: Authenticate to Power Platform
        shell: powershell
        run: |
          Write-Host "üîê Authenticating..."
          & "$env:PAC_PATH" auth clear
          & "$env:PAC_PATH" auth create --url https://org643d7b2c.crm12.dynamics.com --username "nicoise.nkounkou@edu.igensia.com" --password $env:PASSWORD
          & "$env:PAC_PATH" auth list
        env:
          PASSWORD: ${{ secrets.PASSWORD }}

      # √âtape 5 : Export de la solution
      - name: Export Solution
        shell: powershell
        run: |
          mkdir out -Force
          & "$env:PAC_PATH" solution export --name aSolution --path out\aSolution.zip --environment https://org643d7b2c.crm12.dynamics.com
        env:
          PASSWORD: ${{ secrets.PASSWORD }}

      # √âtape 6 : D√©compactage de la solution
      - name: Unpack Solution
        shell: powershell
        run: |
          & "$env:PAC_PATH" solution unpack --zipfile out\aSolution.zip --folder out\solutions\solution-one --allowDelete true --overwrite true

      # √âtape 7 : Publication
      - name: Publish Solution
        shell: powershell
        run: |
          & "$env:PAC_PATH" solution publish --environment https://org643d7b2c.crm12.dynamics.com

      # √âtape 8 : Commit dans le d√©p√¥t
      - name: Commit solution to source control
        uses: microsoft/powerplatform-actions/branch-solution@v1
        with:
          solution-folder: 'out/solutions/solution-one'
          solution-target-folder: 'src/solutions/solution1'
          token: ${{ secrets.GIT_TOKEN }}
